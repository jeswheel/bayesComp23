---
title: 'Informing Policy via Dynamic Models: Cholera in Haiti'
author: 
  - Jesse Wheeler
  - AnnaElaine Rosengart
  - Zhuoxun Jiang
  - Kevin Hao En Tan
  - Noah Treutle
  - Edward Ionides
date: "`r Sys.Date()`"
always_allow_html: true
output:
  beamer_presentation:
    theme: "AnnArbor"
    colortheme: "seahorse"
    fonttheme: "structurebold"
bibliography: bib-haiti.bib
csl: statistical-science.csl
header-includes:
  - \AtBeginEnvironment{CSLReferences}{\small}
  - \usepackage{makecell}
  - \usepackage{multicol}
  - \usepackage{multirow}
  - \usepackage{xcolor}
---

```{r setup, include=FALSE}
library(tidyverse)
library(haitipkg)
library(DiagrammeR)

myround <- function (x, digits = 1) {
  # taken from the broman package
  if (digits < 1)
    stop("This is intended for the case digits >= 1.")
  if (length(digits) > 1) {
    digits <- digits[1]
    warning("Using only digits[1]")
  }
  tmp <- sprintf(paste("%.", digits, "f", sep = ""), x)
  zero <- paste0("0.", paste(rep("0", digits), collapse = ""))
  tmp[tmp == paste0("-", zero)] <- zero
  tmp
}

dep_labeller <- as_labeller(
  c(
    'Artibonite' = 'Artibonite',
    'Sud_Est' = 'Sud-Est',
    'Sud.Est' = 'Sud-Est',
    'Nippes' = 'Nippes',
    'Nord_Est' = 'Nord-Est',
    'Nord.Est' = 'Nord-Est',
    'Ouest' = 'Ouest',
    'Centre' = 'Centre',
    'Nord' = 'Nord',
    'Sud' = 'Sud',
    'Nord_Ouest' = 'Nord-Ouest',
    'Nord.Ouest' = 'Nord-Ouest',
    'Grande_Anse' = 'Grand\'Anse',
    'Grand.Anse' = 'Grand\'Anse'
  )
)

theme_set(theme_bw())

knitr::opts_chunk$set(
  echo = FALSE,
  fig.height = 3, 
  fig.width = 4.75,
  message = FALSE
)
```

# Introduction

## Partially Observed Markov Processes 

- The models we focus on are partially observed Markov processes (POMP)

![Credit: @king22](images/pomp.png){width=70%}

## POMP Models 

- Parameter vector $\theta$ that indexes the model
- One step transition density: $f_{X_n|X_{n - 1}}(x_n|x_{n -1};\theta)$ that we can simulate from (may not be able to evaluate or express in closed form).
- Measurement Model: $f_{Y_{n}|X_n}(y_n|x_n; \theta)$.
- Initial density: $f_{X_0}(x_0;\theta)$

## Advantages of Statistical Modeling

- Nonlinear-dynamic statistical models have proven to be a useful tool for modeling infectious disease outbreaks (TODO: CITE)
- Most common examples are SIR models and their various extensions. 
- These models enable the modeling of scientifically meaningful states, prediction of the future of the outbreak, and modeling the potential effects of interventions (such as vaccinations) (TODO: CITE)

## Concerns 

- Despite their utility, there exist many cautionary warnings against the use of these types of models (TODO: CITE). 
- Concerns include: 
    - TODO 
    - TODO
    - TODO
- Despite these warnings, there is very little practical advice on how to approach these issues.

## Cholera in Haiti 

- We consider the 2010-2019 cholera outbreak in Haiti.
- Cholera was introduced to Haiti in 2010 following the devastating earthquake of the same year. 
- Although some new cases have been detected, there were no recorded cholera cases in Haiti between February, 2019 and September 2022 (TODO: Cite).

## Data

```{r prepData, include=FALSE, echo=FALSE, message=FALSE}
plot_df <- haitiCholera %>%
  select(-report) %>%
  mutate(date = as.Date(date_saturday)) %>%
  select(-date_saturday) %>%
  pivot_longer(
    data = .,
    cols = -c(date),
    names_to = 'Departement',
    values_to = "Cases",
  )
```

```{r plotNationalData, cache=TRUE}
true_agg_cases <- haitiCholera %>%
  select(-report) %>%
  pivot_longer(
    data = .,
    cols = -date_saturday,
    values_to = 'cases',
    names_to = 'dep'
  ) %>%
  mutate(
    date = as.Date(date_saturday),
    dep = gsub("\\.", "_", dep)
  ) %>%
  mutate(
    dep = case_when(dep == "Grand_Anse" ~ "Grande_Anse", TRUE ~ dep)
  ) %>%
  tidyr::pivot_wider(
    data = .,
    id_cols = c(date),
    names_from = dep,
    values_from = cases,
    names_prefix = 'cases_'
  ) %>%
  mutate(
    ReportedAll = cases_Artibonite + cases_Centre +
      cases_Grande_Anse + cases_Nippes + cases_Nord +
      cases_Nord_Est + cases_Ouest + cases_Sud +
      cases_Sud_Est + cases_Nord_Ouest
  )

ggplot(true_agg_cases, aes(x = date, y = ReportedAll)) + 
  geom_line() + 
  theme(axis.title.x = element_blank()) + 
  ylab("Reported Cases") +
  scale_y_log10(
    labels = scales::trans_format("log10", scales::math_format(10^.x))
  ) + 
  scale_x_date(date_labels = "%Y", breaks = seq.Date(from = as.Date("2011-01-01"), as.Date("2019-01-01"), by = '1 years'))
```

## Data

```{r PlotData, cache=TRUE}
ggplot(plot_df, aes(x = date, y = Cases + 1)) +
  facet_wrap(~Departement, nrow = 2, labeller = dep_labeller) +
  geom_line() +
  theme(
    axis.title.x = element_blank(),
    axis.text.x = element_text(size = 8)
  ) +
  ylab('Reported Cases') +
  scale_y_log10(labels = scales::trans_format("log10", scales::math_format(10^.x))) +
  scale_x_date(date_labels = "'%y", breaks = seq.Date(from = as.Date("2011-01-01"), as.Date("2019-01-01"), by = '2 years'))
```

```{r cleanPlotDf, include=FALSE, message=FALSE, echo=FALSE}
rm(plot_df)
gc()
```

## Models 

- We build on the study by Lee et. al (2020), in which four independent teams built non-linear models to describe cholera dynamics.

| | Model 1 | Model 2 | Model 3 |
| ------- | ------- | ------- | ------- | 
| Deterministic / Stochastic | Stochastic | Deterministic | Stochastic | 
| Spatial Model | No | Yes | Yes | 
| Fitting Method | IF2 | Trajectory Matching | IBPF | 

## Goals

Our goals in this study is to provide practical advice on how to use non-linear dynamic models to make inference on a dynamic system. 
We specifically focus on the following topics: 

- Model Fitting 
- Diagnostics 
- Forecasting
- Interpreting Results 
- Reproducibility

# Model Fitting 

## Computing 

- Parameters of nonlinear dynamic models are often fit by finding their posterior distribution or by maximizing some objective measure.
- Because of the non-linear nature of the models, this can be computationally expensive. 
- Great care should be taken to determine the necessary amount of computation needed to solve the problem at hand. 

## Example: Model 3 

- We calibrate this model using the new IBPF algorithm (TODO: Cite), which enables parameter estimation via maximum likelihood for high-dimensional nonlinear POMP models.
- The original version of this model was fit using an alternative approach designed to maximize the model likelihood. 
- Without modifications to the model, we obtained parameter estimates corresponding to hundreds of log-likelihood unit improvements to the original model fit. 

## Nested Models 

- Non-linear dynamic models make assumptions about the dynamics of the system in question. 
- Consider testing scientifically meaningful nested hypothesis. 
- For example, we consider adding a linear trend in transmission to Model 1 in order to account for the apparent decrease in cholera cases. 

## Example: Model 1 

![Model 1](images/model1.pdf)

## Model 1 (Continued...)

- Individuals move $S \rightarrow E$ at time $t$ with a rate of $\lambda(t)$, where: 

$$
\lambda(t) = (I + \epsilon A)^\nu \color{red}{\frac{d\Gamma(t)}{dt}} \color{black}{\beta(t)/N},
$$
$$
\log \beta(t) = \sum_{j = 1}^6\beta_js_j(t) + \color{red}{\xi \bar{t}}
$$

- $\frac{d\Gamma}{dt}$ is multiplicative Gamma white-process noise, $\epsilon, \nu, \xi, \beta_{1:6}$ are parameters to be estimated, $s_{1:6}(t)$ are a B-spline basis. 

## Testing a linear trend 

- We test for a linear trend in transmission using a 95% Monte Carlo adjust profile confidence interval (MCAP-CI) (TODO: Cite).
- The test suggests a marginally significant negative linear trend in transmission, with confidence interval $\xi \in (-0.085, -0.005)$.

![MCAP-CI for linear trend in transmission](images/trend.pdf){width=68%}

# Model Diagnostics 

## Don't just rely on simulations 

text

## Interpreting Results

text

# Model Forecasts 

## Model Forecasts

- One of the primary reasons dynamic models are fit to data is to obtain forecasts of the future state of the system. 
- When done carefully, forecasts can be helpful in informing policy and may enable real-time testing of new scientific hypothesis @lewis22.

## Using Real-time data on the system 

- Recent information about a dynamic system should be more relevant for a forecast than older information. 
- While the previous statement seems self-evident, it is not the case for deterministic models which depend only on initial conditions, and is often not done in practice. 
- Let $X_{0:N}$ and $Y_{1:N}$ be random vectors denoting the latent and observed states from times $t_0, t_1, \ldots, t_N$, and let $y_{1:N}^*$ be the observed data that we use to fit a model. 
- Forecasts for future times $t_{N+1}, \ldots, t_{N+s}$ should be based on draws from $f_{Y_{N+1:N+S}|Y_{1:N} = y_{1:N}^*}(Y_{N+1:N+S}|Y_{1:N} = y_{1:N}^*; \hat{\theta})$, which can be done simulating starting from hidden states drawn from the filtering distribution at time $t_N$.

## Accounting for All Uncertainty 

- Deterministic models are useful for obtaining estimates of general trends of the system but can lead to over-confidence in model forecasts (TODO: Cite kings paper). 
- Stochastic models account can include randomness in both the process and measurement models (TODO: Cite ionides paper on this)
- It is important to also account for uncertainty in parameter estimates, as uncertainty in just a single parameter can lead to drastically different forecasts @saltelli20. 

# Reproducibility

## Reproducibility 

Text

## Bibliography
